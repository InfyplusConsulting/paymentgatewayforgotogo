// --- 1. INITIAL SETUP ---
const express = require('express');
const cors = require('cors');
const crypto = require('crypto');
const Razorpay = require('razorpay');
require('dotenv').config();

const app = express();
const PORT = process.env.PORT || 3000;

// INCREASE PAYLOAD SIZE LIMIT (Important for uploading files/images)
app.use(express.json({ limit: '50mb' })); 
app.use(express.urlencoded({ limit: '50mb', extended: true }));

const allowedOrigins = [
  'https://gotogo-merger.netlify.app',
  'http://127.0.0.1:5500',
  'http://localhost:5500',
  'https://www.gotogotravelsolutions.com',
  'https://gotogotravelsolutions.com'
];

const corsOptions = {
  origin: function (origin, callback) {
    if (allowedOrigins.indexOf(origin) !== -1 || !origin) {
      callback(null, true);
    } else {
      callback(new Error('Not allowed by CORS'));
    }
  },
};

app.use(cors(corsOptions));

const razorpay = new Razorpay({
  key_id: process.env.RAZORPAY_KEY_ID,
  key_secret: process.env.RAZORPAY_KEY_SECRET,
});

// --- HELPER: UPLOAD TO GITHUB ---
async function uploadToGitHub(base64Content, fileName) {
    try {
        const url = `https://api.github.com/repos/${process.env.GITHUB_USERNAME}/${process.env.GITHUB_REPO}/contents/passports/${fileName}`;
        
        const response = await fetch(url, {
            method: 'PUT',
            headers: {
                'Authorization': `Bearer ${process.env.GITHUB_TOKEN}`,
                'Content-Type': 'application/json',
                'User-Agent': 'GoToGo-Backend'
            },
            body: JSON.stringify({
                message: `Upload passport ${fileName}`,
                content: base64Content,
                encoding: 'base64'
            })
        });

        if (!response.ok) {
            const errText = await response.text();
            console.error("GitHub Error:", errText);
            return "Upload Failed"; // Fallback text
        }

        const data = await response.json();
        return data.content.download_url; // This is the link we save to Sheet
    } catch (error) {
        console.error("GitHub Upload Exception:", error);
        return "Upload Error";
    }
}

// --- HELPER: PROCESS TRAVELER FILES ---
async function processTravelerFiles(travelers) {
    // Loop through travelers and check if they have a file to upload
    const updatedTravelers = await Promise.all(travelers.map(async (t) => {
        if (t.passportFileBase64) {
            const timestamp = Date.now();
            // Clean filename
            const cleanName = (t.name || 'traveler').replace(/[^a-zA-Z0-9]/g, "_");
            const fileName = `${timestamp}_${cleanName}.${t.fileExtension || 'png'}`;
            
            // Upload to GitHub
            const fileUrl = await uploadToGitHub(t.passportFileBase64, fileName);
            
            // Return updated traveler object (Remove huge base64 string, add clean URL)
            return {
                ...t,
                documentUrl: fileUrl,
                passportFileBase64: undefined, // Remove heavy data
                fileExtension: undefined
            };
        }
        return t; // Return as is if no file
    }));
    
    return updatedTravelers;
}

app.get('/ping', (req, res) => {
  console.log('Server was pinged and is now awake.');
  res.json({ success: true, message: 'Server is awake and ready.' });
});

// --- GOOGLE APPS SCRIPT FUNCTION ---
async function addBookingToSheet(bookingDetails) {
  const payload = {
      ...bookingDetails,
      authToken: process.env.APPS_SCRIPT_AUTH_TOKEN 
  };
  
  const response = await fetch(process.env.GOOGLE_SCRIPT_URL, {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify(payload),
  });

  const text = await response.text();
  console.log("Apps Script response body:", text);

  let result;
  try {
      result = JSON.parse(text);
  } catch (e) {
      console.error("Failed to parse Apps Script response:", text);
      throw new Error("Internal Server Error: Script response malformed.");
  }

  if (result.success === false) {
      console.error("Apps Script reported failure:", result.error);
      throw new Error(`Booking processing failed: ${result.error}`);
  }
  console.log("Successfully sent and processed booking via Google Script.");
}

// == ROUTE 1: CREATE ORDER ==
app.post('/create-order', async (req, res) => {
  const { amount, currency, receipt } = req.body;
  const options = { amount, currency, receipt };
  try {
    const order = await razorpay.orders.create(options);
    res.json(order);
  } catch (error) {
    console.error('Error creating Razorpay order:', error);
    res.status(500).send('Error creating order');
  }
});

// == ROUTE 2: VERIFY PAYMENT (UPDATED FOR FILES) ==
app.post('/verify-payment', async (req, res) => {
  const { razorpay_order_id, razorpay_payment_id, razorpay_signature, travelers } = req.body;

  const key_secret = process.env.RAZORPAY_KEY_SECRET;
  const hmac = crypto.createHmac('sha256', key_secret);
  hmac.update(razorpay_order_id + '|' + razorpay_payment_id);
  const generated_signature = hmac.digest('hex');

  if (generated_signature === razorpay_signature) {
    console.log('Payment verified. Processing files...');

    // 1. Process Files (Upload to GitHub)
    const travelersWithUrls = await processTravelerFiles(travelers || []);

    // 2. Send to Google Sheet (With URLs)
    await addBookingToSheet({
      ...req.body,
      travelers: travelersWithUrls, // Use the updated list
      paymentMethod: 'Razorpay',
      paymentId: razorpay_payment_id,
    });

    // 3. Respond to Frontend
    res.json({ 
        success: true, 
        message: 'Payment verified & booking processed.',
        // Return travelers with URLs so frontend can use them if needed
        travelers: travelersWithUrls 
    });
  } else {
    console.log('Payment verification failed.');
    res.status(400).json({ success: false, message: 'Payment verification failed' });
  }
});

// == ROUTE 3: CASH BOOKING (UPDATED FOR FILES) ==
app.post('/book-cash', async (req, res) => {
  console.log('Cash booking received. Processing files...');

  try {
    // 1. Process Files (Upload to GitHub)
    const travelersWithUrls = await processTravelerFiles(req.body.travelers || []);

    // 2. Send to Google Sheet (With URLs)
    await addBookingToSheet({
      ...req.body,
      travelers: travelersWithUrls, // Use the updated list
      paymentMethod: 'Cash',
      paymentId: 'N/A',
    });

    res.json({ success: true, message: 'Cash booking processed successfully.' });
  } catch (error) {
    console.error('Failed to process cash booking:', error.message);
    res.status(500).json({ 
        success: false, 
        message: 'Server error during cash booking processing. Pls Contact support.' 
    });
  }
});

app.listen(PORT, () => {
  console.log(`Server is running successfully on http://localhost:${PORT}`);
});